<div id="{{results}}">

  <div class="predictions" data-bind="if: {{results}}">

    <h3>Predicting upcoming games</h3>
    <table class="table">
      <tbody>
        <tr data-bind="foreach: {{results}}">
          <td data-bind="if: !$index()"></td>
          <td><img data-bind="attr: {src: '{{basepath}}img/' + at + '.svg'}"></img></td>
        </tr>
        <tr data-bind="foreach: {{results}}">
          <td data-bind="if: !$index()"></td>
          <td>@</td>
        </tr>
        <tr class="separation" data-bind="foreach: {{results}}">
          <td data-bind="if: !$index()"></td>
            <td><img data-bind="attr: {src: '{{basepath}}img/' + ht + '.svg'}"></img></td>
        </tr>
        <tr class="separation results" data-bind="foreach: {{results}}">
          <td data-bind="if: !$index()">Winner</td>
          <td>
            <img class="winner" data-bind="attr: {src: '{{basepath}}img/' + ot + '.svg'}"></img>
            <div data-bind="text: o.toFixed(0) + '%'"></div>
          </td>
        </tr>
        <tr class="results" data-bind="foreach: {{results}}">
          <td data-bind="if: !$index()">Rate</td>
          <td>
            <img data-bind="attr: {src: '{{basepath}}img/' + wt + '.svg'}"></img>
            <div data-bind="text: w.toFixed(1)"></div>
          </td>
        </tr>
        <tr data-bind="foreach: {{results}}">
          <td data-bind="if: !$index()">Points</td>
          <td>
            <img data-bind="attr: {src: '{{basepath}}img/' + pt + '.svg'}"></img>
            <div data-bind="text: p.toFixed(0)"></div>
          </td>
        </tr>
        <tr data-bind="foreach: {{results}}">
          <td data-bind="if: !$index()">Yards</td>
          <td>
            <img data-bind="attr: {src: '{{basepath}}img/' + yt + '.svg'}"></img>
            <div data-bind="text: y.toFixed(0)"></div>
          </td>
        </tr>
        <tr data-bind="foreach: {{results}}">
          <td data-bind="if: !$index()">Turnovers</td>
          <td>
            <img data-bind="attr: {src: '{{basepath}}img/' + tt + '.svg'}"></img>
            <div data-bind="text: t.toFixed(1)"></div>
          </td>
        </tr>

      </tbody>
    </table>
    <div class="explanations">Positive numbers indicates advantage for home team.</div>
    <br>

  </div>

</div>

<script type="text/javascript">
  function sign(x) { return x > 0 ? 1 : x < 0 ? -1 : 0; }

  (function () {
  var keystats = '_' + {{season}} + ({{week}} < 10 ? '0' : '') + {{week}};
  var season = {{week}} < 21 ? {{season}} : {{season}} + 1;
  var week = {{week}} < 21 ? {{week}} + 1 : 1;
  if ({{week}} == 1 &&
      {{results}} == pred1) {
    keystat = '_' + {{season - 1}} + 21;
    season = {{season}};
    week = {{week}};
  }

  var key = '_' + season + (week < 10 ? '0' : '') + week;
  var data = hf.stats.data[key];
  var home, away, games, overall, results;
  if (data && data.games && data.games.length) {
    home = hf.stats.data[keystats].stats.home;
    away = hf.stats.data[keystats].stats.away;
    overall = hf.stats.data[keystats].stats.overall;
    var homestat = function(t, offdef, s) {
      // For superbowl prediction, we take overall stats for both teams
      if ({{week}} == 20) {
        return overall[t].s[offdef][s];
      }
      return home[t].s[offdef][s];
    };
    var awaystat = function(t, offdef, s) {
      // For superbowl prediction, we take overall stats for both teams
      if ({{week}} == 20) {
        return overall[t].s[offdef][s];
      }
      return away[t].s[offdef][s];
    };

    results = [];
    var mmw = {
      min: undefined,
      max: undefined
    }
    var maxw, maxp, maxy, maxt;
    var minw, minp, miny, mint;
    data.games.forEach(function(g) {
      var w = homestat(g.ht, 'o', 'w') - awaystat(g.at, 'o', 'w');
      var wt = w > 0 ? g.ht : g.at;
      var p = (homestat(g.ht, 'o', 'p') - homestat(g.ht, 'd', 'p')) -
              (awaystat(g.at, 'o', 'p') - awaystat(g.at, 'd', 'p'));
      var pt = p > 0 ? g.ht : g.at;
      var y = (homestat(g.ht, 'o', 'y') - homestat(g.ht, 'd', 'y')) -
              (awaystat(g.at, 'o', 'y') - awaystat(g.at, 'd', 'y'));
      var yt = y > 0 ? g.ht : g.at;
      var t = (homestat(g.ht, 'o', 't') - homestat(g.ht, 'd', 't')) -
              (awaystat(g.at, 'o', 't') - awaystat(g.at, 'd', 't'));
      var tt = t > 0 ? g.ht : g.at;
      results.push({
        ht: g.ht,
        at: g.at,
        w: w,
        wt: wt,
        p: p,
        pt: pt,
        y: y,
        yt: yt,
        t: t,
        tt: tt
      });
      maxw = (maxw == undefined || w > maxw) ? w : maxw;
      maxp = (maxp == undefined || p > maxp) ? p : maxp;
      maxy = (maxy == undefined || y > maxy) ? y : maxy;
      maxt = (maxt == undefined || t > maxt) ? t : maxt;
      minw = (minw == undefined || w < minw) ? w : minw;
      minp = (minp == undefined || p < minp) ? p : minp;
      miny = (miny == undefined || y < miny) ? y : miny;
      mint = (mint == undefined || t < mint) ? t : mint;
    });
    // symetric values
    if (sign(maxw) != sign(minw)) {
      if (Math.abs(maxw) > Math.abs(minw)) {
        minw = Math.abs(maxw) * (Math.abs(minw)/minw);
      } else {
        maxw = Math.abs(minw) * (Math.abs(maxw)/maxw);
      }
    }

    if (sign(maxp) != sign(minp)) {
      if (Math.abs(maxp) > Math.abs(minp)) {
        minp = Math.abs(maxp) * (Math.abs(minp)/minp);
      } else {
        maxp = Math.abs(minp) * (Math.abs(maxp)/maxp);
      }
    }

    if (sign(maxy) != sign(miny)) {
      if (Math.abs(maxy) > Math.abs(miny)) {
        miny = Math.abs(maxy) * (Math.abs(miny)/miny);
      } else {
        maxy = Math.abs(miny) * (Math.abs(maxy)/maxy);
      }
    }

    if (sign(maxt) != sign(mint)) {
      if (Math.abs(maxt) > Math.abs(mint)) {
        mint = Math.abs(maxt) * (Math.abs(mint)/mint);
      } else {
        maxt = Math.abs(mint) * (Math.abs(maxt)/maxt);
      }
    }
    var slep = function(v, max, min) {
      if (max == min) {
        return 100.0;
      }
      return 100 * ((v - min) / (max - min));
    }
    
    results.forEach(function(r) {
      r.ww = slep(r.w, maxw, minw);
      r.pw = slep(r.p, maxp, minp);
      r.yw = slep(r.y, maxy, miny);
      r.tw = slep(r.t, maxt, mint);

      r.o = ((6*r.ww) + (3*r.pw) + (2*r.tw) + r.yw) / 12.0;
      r.ot = r.ht;
      if (r.o < 50) {
        r.o = 100 - r.o;
        r.ot = r.at;
      }
    });

  }
  {{results}} = results;

  }());
  ko.applyBindings({{results}}, document.getElementById('{{results}}'));
</script>

